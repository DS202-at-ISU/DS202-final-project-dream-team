---
title: "DS 202 Final Project"
output: 
  github_document:
    number_section: FALSE
---

<!-- README.md is generated from README.Rmd. Please edit the README.Rmd file -->

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = FALSE, warning = TRUE)


knit_hooks$set( fig.cap = function(before, options, envir) {
  if ( before ) {
    chr <- sprintf("<p><small><strong><a name='fig:%s' value = %d>Figure %d</a></strong>: %s</small></p>", options$label, options$fig.num, options$fig.num, options$fig.cap)
    chr <- sprintf("<p><small><strong><a name='fig:%s'>%s</a></strong>: %s</small></p>", options$label, options$label,  options$fig.cap)
    
    return(chr)
  }
})


chunkref <- local({
  function(chunklabel) {
    sprintf('[%s](#%s)', chunklabel, paste0("fig:",chunklabel) )
  }  
})

library(ggplot2)
library(dplyr)
library(stringr)
library(tidyverse)
```

This repository serves as a starter repo for your final project, and this Rmd is supposed to serve as a starter file for your project report.

## Part I: Repo Structure {.unnumbered}

The structure sketched out below is an idea of what your repository might look like. You can use it as a starting base and change according to your needs. But think about the changes that you make!

```         
-- code
|   |   -- any R scripts you need but don't want to include directly in the write-up
-- data
|   |   -- csv files (cleaned data)
-- data-raw
|   |   -- raw data files 
|   |   -- data description files, origin
|   |   -- Codebook
-- final-project.Rmd
-- images  # only images that are not created by the Rmd
-- LICENSE
-- README.md
-- README.Rmd
-- README_files # folder with files created during the knitting process
```

## Part II: Project report {.unnumbered}

# Consumer Spending in Iowa {.unnumbered}

Authors: Kylie Tauke, Jordyn Reimer, and Akshat Valse

## Abstract (TL;DR) {.unnumbered}

The data explored in this project details estimates on consumer spending in the state of Iowa. We wanted to identify what consumers spend the most on and how it has changed throughout the years. The data comes from the U.S. Bureau of Economic Analysis.

ADD FINDINGS LATER

THINGS TO NOTE
- page number on slide
- facet by categorical variables
- not too much text on slides
- he's kinda picky on what type of figure you use
  - stacked vs dodge bar chart
  - percent vs count bar chart

# Motivation

We wanted to examine consumer spending in Iowa. Not only were we curious about the distribution of spending among different categories of goods, but this is also valuable information for any business providing a good or service.

At the end of the Intro, write a sentence describing what each of the (result) sections is about, e.g. in section [Results 1] we show the relationship between XXX and YYY, section [Results 2: Modeling Using Random Forests] also considers the effect of variable ZZZ. ... Finally we conclude with a quick summary of our findings and potential follow-up work in section [Conclusions].

# Quick Data Summary

```{r, include = FALSE}
data <- read.csv("https://data.iowa.gov/api/views/xwex-75fk/rows.csv?accessType=DOWNLOAD")

colnames(data) <- colnames(data) %>% 
  tolower() %>% 
  str_replace_all("[^a-z0-9]", "_")

clean_data <- data %>% mutate(
    category = ifelse(
      grepl(":", variable),  
      sub(".*:\\s*", "", variable),  
      variable  
    ),
    category = trimws(category),  
    expenditure_type = ifelse(grepl("Per capita", variable), "per_capita", "total")
  ) %>%
  
  tidyr::separate(
    row_id,
    into = c("fips_code", "data_year", "series_code", "frequency"),
    sep = "_",
    remove = FALSE
  ) %>%
  
  mutate(
    data_year = as.integer(data_year),
    reported_year = as.integer(reported_year),
    prior_year = as.integer(prior_year),
    value = as.numeric(value),
    date = as.Date(date, format = "%m/%d/%Y")
  ) %>%

  mutate(
    unit = case_when(
      grepl("Dollars", variable_unit) ~ "dollars",
      grepl("Millions", variable_unit) ~ "millions_dollars",
      TRUE ~ tolower(gsub("[^a-z]", "", variable_unit))
    ),
    value_millions = ifelse(unit == "dollars", value/1e6, value)
  )

print(colnames(data))

clean_data

```

-   The data was cleaned by standardizing column names, extracting simplified categories from text fields, splitting composite IDs into separate columns, converting data types (dates, numbers), normalizing units to millions, and removing duplicates.

What are the variables that you will be using in the main part of the report? What are their ranges? You could include a table with variable names, a short explanation, and (very broad) summary statistics.

-   The primary variables that will be used will be consumption_category, reported_year, and value_millions. Some summaries and preliminary plots are provided below.

```{r summaries}
summary(clean_data)

clean_data %>% 
  filter(category == "Total personal consumption expenditures") %>% 
  ggplot(aes(reported_year, value)) + 
  geom_point() + 
  geom_line()

clean_data %>% filter(!(category %in% c(
  "Total personal consumption expenditures", 
  "Per capita personal consumption expenditures (PCE) by state", 
  "Final consumption expenditures of nonprofit institutions serving households (NPISHs)", 
  "Services", 
  "Household consumption expenditures (for services)"
  ))) %>% ggplot(aes(category, value)) + geom_boxplot() + coord_flip()
```

# Results

Each line of exploration is supposed to be featured in one of the Results sections. Make sure to change to more interesting section headers!

## Results 1

In your write-up, make sure to refer to all of the figures you create. You can include a hyperlink to the [scatterplot](#fig:scatterplot) by using the name of the code chunk (make sure, to give each code chunk a different name). In your markdown document you can create this link either by calling the function `chunkref` with the name of the code chunk in quotes, i.e. `r chunkref("scatterplot")` or by using the markdown expression `[scatterplot](#fig:scatterplot)`. Similarly, we can refer to the `r chunkref("2nd scatterplot")`. Note that the figure captions appear above the figures - this saves us from having to scroll up after following the link.

```{r scatterplot, echo=FALSE, fig.cap="This is the figure caption. Make sure to use the description we practised in the homework: first sentence describes structure of the plot, second sentence describes main finding, third sentence describes outliers/follow-up.", message = FALSE}


clean_data %>% 
  filter(category == "Total personal consumption expenditures") %>% 
  ggplot(aes(x = reported_year, y = value_millions)) +
  geom_line() +
  labs(x = "Year", y = "Expenditures (Millions USD)", title = "Total Consumer Spending Over Time")

```

```{r 2nd scatterplot, echo=FALSE, fig.cap="This is the figure caption. Make sure to use the description we practised in the homework: first sentence describes structure of the plot, second sentence describes main finding, third sentence describes outliers/follow-up.", message = FALSE}


clean_data %>%
  filter(!is.na(category)) %>%
  group_by(category) %>%
  summarize(total_spending = sum(value_millions, na.rm = TRUE)) %>%
  top_n(5, total_spending) %>%
  ggplot(aes(reorder(category, total_spending), total_spending)) +
  geom_col() +
  coord_flip() +
  labs(x = "Category", y = "Total Spending (Millions USD)", title = "Top 5 Spending Categories")

```

Additionally, you can also refer to different sections in your writeup by using anchors (links) to section headers. Here, we are referring to subsection [Results 3: Volatility in Spending Categories Over Time]. The code for that is `[Results 3]`.

## Results 2: Modeling Using Random Forests

```{r}
library(randomForest)

# Filter down to a manageable number of categories
top_categories <- clean_data %>%
  count(category, sort = TRUE) %>%
  slice_head(n = 10) %>%
  pull(category)

rf_data <- clean_data %>%
  filter(category %in% top_categories) %>%
  select(category, reported_year, value_millions) %>%
  na.omit()

# Make sure 'category' is a factor for classification
rf_data$category <- as.factor(rf_data$category)

set.seed(123)  # for reproducibility
train_idx <- sample(seq_len(nrow(rf_data)), size = 0.8 * nrow(rf_data))
train_data <- rf_data[train_idx, ]
test_data <- rf_data[-train_idx, ]

rf_model <- randomForest(category ~ reported_year + value_millions, data = train_data, ntree = 500, importance = TRUE)
rf_model

```

```{r}
predictions <- predict(rf_model, newdata = test_data)
confusion_matrix <- table(predictions, test_data$category)
confusion_matrix

accuracy <- sum(diag(confusion_matrix)) / sum(confusion_matrix)
accuracy

```

```{r}
varImpPlot(rf_model, main = "Variable Importance Plot")
```

## Results 3: Volatility in Spending Categories Over Time

```{r}


# Focus on top 8 categories for clarity
top_categories_heatmap <- clean_data %>%
  group_by(category) %>%
  summarize(total_spending = sum(value_millions, na.rm = TRUE)) %>%
  arrange(desc(total_spending)) %>%
  slice_head(n = 8) %>%
  pull(category)

# Filter for plotting
heatmap_data <- clean_data %>%
  filter(category %in% top_categories_heatmap)

# Plot
ggplot(heatmap_data, aes(x = reported_year, y = fct_reorder(category, desc(category)), fill = value_millions)) +
  geom_tile() +
  scale_fill_viridis_c(option = "C", name = "Spending\n(Millions USD)") +
  labs(
    title = "Heatmap of Consumer Spending by Category and Year",
    x = "Year",
    y = "Category"
  ) +
  theme_minimal()



```

# Conclusions

Give a quick summary of your work. Here is the place to be a bit critical and discuss potential limitations. Add a sentence on what else you would have liked to include in your data exploration if you had more time or more members in your team.

-   In this project, we explored consumer spending patterns in Iowa using data from the U.S. Bureau of Economic Analysis. We analyzed overall spending trends over time, built a random forest model to predict spending categories based on expenditure and year, and visualized shifts in major spending categories through a heatmap. Our results show that total consumer spending in Iowa has steadily increased over the past two decades, with essential categories like healthcare and housing consistently dominating expenditure. Meanwhile, discretionary categories such as food services and recreation displayed greater volatility.

    One limitation of our analysis is that we did not adjust spending figures for inflation or population growth, which could affect year-to-year comparisons. Additionally, our predictive model only used two variables incorporating more economic indicators (such as unemployment rates, income levels, or demographic shifts) might improve model accuracy and interpretation.

    If we had more time or additional team members, we would have liked to build a forecasting model to predict future consumer spending by category. We also would have explored spatial differences across counties in Iowa to investigate whether spending patterns vary geographically within the state.

## Data source {.unnumbered}

Where does the data come from, who owns the data? Where are all the scripts that you need to clean the data?

## References {.unnumbered}

List all resources you used.
